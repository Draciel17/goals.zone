language: python
python:
- '3.6'
jobs:
  include:
    - stage: test
      script:
        - pip install -r requirements.txt
        - python manage.py test --noinput
    - stage: deploy
      script:
        - openssl aes-256-cbc -K $encrypted_62d57faec6f0_key -iv $encrypted_62d57faec6f0_iv
          -in deploy_key.enc -out ./deploy_key -d
        - eval "$(ssh-agent -s)"
        - chmod 600 ./deploy_key
        - echo -e "Host 142.93.99.85\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
        - ssh-add ./deploy_key
        - ssh -i ./deploy_key root@142.93.99.85 ./deploy.sh